rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read all user profiles including follower/following counts (for search, discovery, etc.)
    // Allow users to write/update their own profile
    match /users/{userId} {
      // Anyone can read user profiles (public data including counts)
      allow read: if true;
      // Users can create/update their own profile
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (
        // Allow users to update their own profile fields
        request.auth.uid == userId ||
        // Allow updating only followingCount for own profile
        (request.auth.uid == userId && onlyUpdatingFields(['followingCount'])) ||
        // Allow any authenticated user to update another user's followerCount (when following/unfollowing)
        (onlyUpdatingFields(['followerCount']) && isValidCountUpdate('followerCount'))
      );
      // Users can delete their own profile
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Following subcollection - users can manage who they follow
    match /users/{userId}/following/{targetUserId} {
      // Anyone can read following lists (public followers/following)
      allow read: if true;
      // Only the user can modify their own following list
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Followers subcollection - tracks who follows this user
    match /users/{userId}/followers/{followerId} {
      // Anyone can read follower lists (public followers/following)
      allow read: if true;
      // The follower can add/remove themselves from this user's followers list
      allow write: if request.auth != null && request.auth.uid == followerId;
    }
    
    // Allow authenticated users to create posts and read all posts
    match /posts/{postId} {
      allow read: if true;
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId;
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
      allow update: if request.auth != null && (
        // Allow post owner to update their own posts
        request.auth.uid == resource.data.userId ||
        // Allow updating only the comments count (for comment functionality)
        (onlyUpdatingFields(['comments']) && isIncrementingCommentCount()) ||
        // Allow updating only the likes count (for like functionality)
        (onlyUpdatingFields(['likes']) && isValidLikeUpdate()) ||
        // Allow updating FMK reaction counts
        (onlyUpdatingFields(['fmkReactions']) && isValidFMKUpdate())
      );
    }
    
    // Allow authenticated users to read/write comments
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // Allow authenticated users to manage their own likes on any post
    // Note: userId in like document represents the person doing the liking
    match /likes/{likeId} {
      allow read: if true;
      // Allow users to create likes on any post (like other people's posts)
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId;
      // Allow users to delete their own likes
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
      // Allow users to read their own likes for unlike functionality
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // Rule for comments as subcollection under posts
    match /posts/{postId}/comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // Allow users to manage notifications
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
                 request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // Allow users to manage pokes - simplified rules for debugging
    match /pokes/{pokeId} {
      // Allow authenticated users to read any poke document
      allow read: if request.auth != null;
      // Allow authenticated users to query pokes collection
      allow list: if request.auth != null;
      // Allow authenticated users to create pokes
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.pokerId;
      // Allow poked user to update with response photo and caption
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.pokedUserId &&
                   onlyUpdatingFields(['responsePhotoURL', 'responseTimestamp', 'responseCreatedAt', 'responseCaption']);
    }
    
    // Allow users to manage FMK reactions
    match /fmkReactions/{reactionId} {
      allow read: if true;
      // Allow users to create reactions on any post
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId;
      // Allow users to delete their own reactions
      allow delete: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
      // Allow users to update their own reactions
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    // Allow users to track story views
    match /storyViews/{viewId} {
      // Allow users to read their own story views
      allow read: if request.auth != null && 
                 request.auth.uid == resource.data.userId;
      // Allow authenticated users to query their story views
      allow list: if request.auth != null;
      // Allow users to create story views for themselves
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.userId;
      // Allow users to update their own story views
      allow update: if request.auth != null && 
                   request.auth.uid == resource.data.userId;
    }
    
    
    // Helper function to check if only specific fields are being updated
    function onlyUpdatingFields(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }
    
    // Helper function to check if comments count is being incremented properly
    function isIncrementingCommentCount() {
      return request.resource.data.comments > resource.data.comments &&
             request.resource.data.comments <= resource.data.comments + 1;
    }
    
    // Helper function to check if likes count is being updated properly
    function isValidLikeUpdate() {
      return (request.resource.data.likes == resource.data.likes + 1) ||
             (request.resource.data.likes == resource.data.likes - 1);
    }
    
    // Helper function to check if FMK reaction counts are being updated properly
    function isValidFMKUpdate() {
      let oldFMK = resource.data.get('fmkReactions', {});
      let newFMK = request.resource.data.fmkReactions;
      
      // Check that each reaction type is only incremented/decremented by 1
      return (
        (newFMK.get('fuck', 0) >= oldFMK.get('fuck', 0) - 1 && 
         newFMK.get('fuck', 0) <= oldFMK.get('fuck', 0) + 1) &&
        (newFMK.get('marry', 0) >= oldFMK.get('marry', 0) - 1 && 
         newFMK.get('marry', 0) <= oldFMK.get('marry', 0) + 1) &&
        (newFMK.get('kill', 0) >= oldFMK.get('kill', 0) - 1 && 
         newFMK.get('kill', 0) <= oldFMK.get('kill', 0) + 1)
      );
    }
    
    // Helper function to check if count fields are being updated properly (increment/decrement by 1)
    function isValidCountUpdate(field) {
      let oldCount = resource.data.get(field, 0);
      let newCount = request.resource.data.get(field, 0);
      // Allow increment or decrement by 1, but don't allow going below 0
      return (newCount == oldCount + 1) || (newCount == oldCount - 1 && newCount >= 0);
    }
  }
}